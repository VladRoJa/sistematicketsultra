<!-- frontend-angular/src/app/pantalla-crear-ticket/crear-ticket-refactor.component.html -->
<mat-card class="crear-ticket-card" *ngIf="form">
  <h2 class="titulo-formulario">
    <span style="font-size: 1.3em;">ðŸŽ«</span> Crear Nuevo Ticket
  </h2>

  <form [formGroup]="form" (ngSubmit)="enviar()">

    <!-- Selector de sucursal para admin -->
    <mat-form-field *ngIf="esAdmin()" appearance="fill" class="w-full">
      <mat-label>Sucursal destino</mat-label>
      <mat-select formControlName="sucursal_id" required>
        <mat-option *ngFor="let s of listaSucursales" [value]="s.sucursal_id">
          {{ s.sucursal }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Campos dinÃ¡micos (n1..n5) -->
    <ng-container *ngFor="let nivel of niveles; trackBy: trackByNivel">
    <mat-form-field appearance="fill" class="w-full">
      <mat-label>{{ nivel.etiqueta }}*</mat-label>

      <mat-select [formControl]="nivel.control" [disabled]="nivel.loading">
        <!-- Placeholder cuando no hay opciones -->
        <mat-option *ngIf="!nivel.loading && (!nivel.opciones || !nivel.opciones.length)" [disabled]="true">
          (sin opciones)
        </mat-option>

        <!-- Opciones reales -->
        <mat-option *ngFor="let op of nivel.opciones" [value]="op.id">
          {{ op.nombre }}
        </mat-option>
      </mat-select>
      <!-- Spinner de carga -->
      <mat-progress-spinner
        *ngIf="nivel.loading"
        matSuffix
        diameter="18"
        mode="indeterminate">
      </mat-progress-spinner>

      <mat-error *ngIf="nivel.control.touched && nivel.control.invalid">
        Selecciona {{ nivel.etiqueta.toLowerCase() }}
      </mat-error>
    </mat-form-field>

    </ng-container>



    <!-- Subforms -->
    <ng-container *ngIf="mostrarSubformAparatos; else sistemasOrGenerales">
      <app-mantenimiento-aparatos
        [parentForm]="form"
        tipo="aparato">
      </app-mantenimiento-aparatos>
    </ng-container>

    <ng-template #sistemasOrGenerales>
      <ng-container *ngIf="mostrarSubformSistemasDispositivos; else generales">
        <app-sistemas
          [ocultarPickers]="mostrarSubformSistemasDispositivos"
          [parentForm]="form"
          (formularioValido)="onFormularioSistemasValido($event)">
        </app-sistemas>
      </ng-container>
    </ng-template>

    <ng-template #generales>
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>DescripciÃ³n del problema*</mat-label>
        <textarea matInput formControlName="descripcion_general" rows="3"></textarea>
        <mat-error *ngIf="form.get('descripcion_general')?.touched && form.get('descripcion_general')?.invalid">
          Escribe una descripciÃ³n
        </mat-error>
      </mat-form-field>
    </ng-template>

    <!-- RefacciÃ³n solo Mantenimiento â†’ Edificio  -->
    <div *ngIf="mostrarRefaccion" class="refaccion-block" style="margin: 8px 0 16px;">
      <mat-checkbox formControlName="necesita_refaccion">
        Â¿Requiere refacciÃ³n?
      </mat-checkbox>

      <mat-form-field appearance="fill" class="w-full" style="display:block; margin-top: 8px;">
        <mat-label>DescripciÃ³n tÃ©cnica de la refacciÃ³n (opcional)</mat-label>
        <textarea
          matInput
          formControlName="descripcion_refaccion"
          [disabled]="!form.get('necesita_refaccion')?.value"
          [attr.aria-disabled]="!form.get('necesita_refaccion')?.value"
          rows="3">
        </textarea>
      </mat-form-field>
    </div>


    <!-- Criticidad -->
    <mat-form-field appearance="fill" class="w-full">
      <mat-label>Nivel de criticidad*</mat-label>
      <mat-select formControlName="criticidad">
        <mat-option *ngFor="let n of [1,2,3,4,5]" [value]="n">Nivel {{ n }}</mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('criticidad')?.touched && form.get('criticidad')?.invalid">
        Selecciona criticidad
      </mat-error>
    </mat-form-field>

    <!-- BotÃ³n guardar -->
    <button
      mat-raised-button
      color="primary"
      class="w-full mt-3"
      type="submit"
      [disabled]="loadingGuardar || form.invalid">
      <ng-container *ngIf="!loadingGuardar; else loading">
        Crear ticket
      </ng-container>
      <ng-template #loading>
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
          color="primary"
          style="display:inline-block; vertical-align:middle;">
        </mat-progress-spinner>
      </ng-template>
    </button>

  </form>
</mat-card>
