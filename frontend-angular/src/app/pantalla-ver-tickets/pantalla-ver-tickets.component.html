<!-- pantalla-ver-tickets.component.html -->

<div class="contenedor-tickets">
  <div class="filtros">
    <label for="estado">Estado:</label>
    <select id="estado" [(ngModel)]="filtroEstado" (change)="filtrarTickets()">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="en progreso">En progreso</option>
      <option value="finalizado">Finalizado</option>
    </select>
  
    <label for="criticidad">Criticidad:</label>
    <select id="criticidad" [(ngModel)]="filtroCriticidad" (change)="filtrarTickets()">
      <option value="">Todas las criticidades</option>
      <option value="1">1 - Muy Baja</option>
      <option value="2">2 - Baja</option>
      <option value="3">3 - Media</option>
      <option value="4">4 - Alta</option>
      <option value="5">5 - Critico</option>
    </select>
  
    <label for="departamento">Departamento:</label>
    <select id="departamento" [(ngModel)]="filtroDepartamento" (change)="filtrarTickets()">
      <option value="">Todos los departamentos</option>
      <option *ngFor="let depto of departamentos" [value]="depto.nombre">{{ depto.nombre }}</option>
    </select>
  
    <label for="fechaCreacion">Fecha de Creaci√≥n:</label>
    <input id="fechaCreacion" type="date" [(ngModel)]="filtroFecha" (change)="filtrarTickets()">
  
    <label for="fechaFinalizacion">Fecha de Finalizado:</label>
    <input id="fechaFinalizacion" type="date" [(ngModel)]="filtroFechaFinalizacion" (change)="filtrarTickets()">
  </div>
  
  <button (click)="exportToExcel()">üì• Exportar a Excel</button>

  <!-- ‚úÖ Loader centrado -->
<div *ngIf="loading" class="loader-overlay">
  <svg class="gegga">
    <defs>
        <filter id="gegga">
            <feGaussianBlur in="SourceGraphic" stdDeviation="7" result="blur"></feGaussianBlur>
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -10" result="inreGegga"></feColorMatrix>
            <feComposite in="SourceGraphic" in2="inreGegga" operator="atop"></feComposite>
        </filter>
    </defs>
  </svg>
  <svg class="snurra" width="200" height="200" viewBox="0 0 200 200">
      <defs>
          <linearGradient id="linj√§rGradient">
              <stop class="stopp1" offset="0"></stop>
              <stop class="stopp2" offset="1"></stop>
          </linearGradient>
          <linearGradient y2="160" x2="160" y1="40" x1="40" gradientUnits="userSpaceOnUse" id="gradient" xlink:href="#linj√§rGradient"></linearGradient>
      </defs>
      <path class="halvan" d="m 164,100 c 0,-35.346224 -28.65378,-64 -64,-64 -35.346224,0 -64,28.653776 -64,64 0,35.34622 28.653776,64 64,64 35.34622,0 64,-26.21502 64,-64 0,-37.784981 -26.92058,-64 -64,-64 -37.079421,0 -65.267479,26.922736 -64,64 1.267479,37.07726 26.703171,65.05317 64,64 37.29683,-1.05317 64,-64 64,-64"></path>
      <circle class="strecken" cx="100" cy="100" r="64"></circle>
  </svg>
  <svg class="skugga" width="200" height="200" viewBox="0 0 200 200">
      <path class="halvan" d="m 164,100 c 0,-35.346224 -28.65378,-64 -64,-64 -35.346224,0 -64,28.653776 -64,64 0,35.34622 28.653776,64 64,64 35.34622,0 64,-26.21502 64,-64 0,-37.784981 -26.92058,-64 -64,-64 -37.079421,0 -65.267479,26.922736 -64,64 1.267479,37.07726 26.703171,65.05317 64,64 37.29683,-1.05317 64,-64 64,-64"></path>
      <circle class="strecken" cx="100" cy="100" r="64"></circle>
  </svg>
  <p>Cargando tickets...</p>
</div>
  <div class="table-container" *ngIf="!loading">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Categor√≠a</th>
        <th>Descripci√≥n</th>
        <th>Usuario</th>
        <th>Estado</th>
        <th>Criticidad</th>
        <th>Fecha Creaci√≥n</th>
        <th>Fecha Finalizado</th>
        <th>Departamento</th>
        <th *ngIf="usuarioEsAdmin">Acciones</th>
        <th>Fecha Soluci√≥n</th>
        <th>Historial</th> 
      </tr>
    </thead>

<tbody>
  <tr *ngFor="let ticket of filteredTickets">
    <td>{{ ticket.id }}</td>
    <td>{{ ticket.categoria }}</td>
    <td>{{ ticket.descripcion }}</td>
    <td>{{ ticket.username }}</td>
    <td>{{ ticket.estado }}</td>
    <td>{{ ticket.criticidad }}</td>
    <td>{{ ticket.fecha_creacion }}</td>
    <td>{{ ticket.fecha_finalizado }}</td>
    <td>{{ ticket.departamento }}</td>

           <!-- Acciones -->
           <td *ngIf="usuarioEsAdmin">
            <button 
              *ngIf="ticket.estado === 'pendiente'" 
              (click)="cambiarEstadoTicket(ticket, 'en progreso')"
              class="boton-estado boton-en-progreso">
              En Progreso
            </button>
          
            <button 
              *ngIf="ticket.estado === 'en progreso'"  
              (click)="finalizarTicket(ticket)"
              class="boton-estado boton-finalizar">
              Finalizar
            </button>
          </td>
          
        <td>
          <div *ngIf="!editandoFechaSolucion[ticket.id]; else editando">
            <span (click)="editarFechaSolucion(ticket)" class="fecha-solucion">
              {{ ticket.fecha_solucion ? formatearFechaCorta(ticket.fecha_solucion) : "üìÖ Seleccionar" }}
            </span>
            <button *ngIf="ticket.fecha_solucion" (click)="editarFechaSolucion(ticket)" class="boton-editar">
              ‚úèÔ∏è
            </button>
          </div>
        
          <ng-template #editando>
            <input type="date" [(ngModel)]="fechaSolucionSeleccionada[ticket.id]" class="input-fecha">
            <button (click)="guardarFechaSolucion(ticket)" class="boton-guardar">üíæ</button>
            <button (click)="cancelarEdicion(ticket)" class="boton-cancelar">‚ùå</button>
          </ng-template>
        </td>
        
    
        <!-- ‚úÖ Nueva columna: Historial -->
        <td>
          <button (click)="toggleHistorial(ticket.id)" class="boton-historial">
            {{ historialVisible[ticket.id] ? 'Ocultar Historial' : 'Ver Historial' }}
          </button>
          <div *ngIf="historialVisible[ticket.id]">
            <p *ngIf="!ticket.historial_fechas || ticket.historial_fechas.length === 0">
              No hay historial disponible.
            </p>
            <ul *ngIf="historialVisible[ticket.id]" class="historial-lista">
              <li *ngFor="let item of ticket.historial_fechas" class="historial-item">
                üóì <span class="fecha-nueva">{{ formatearFechaCorta(item.fecha) }}</span> 
                - <b>{{ item.cambiadoPor }}</b>
                (<span class="fecha-modificacion">{{ formatearFechaCorta(item.fechaCambio) }}</span>)
              </li>
            </ul>
            
          </div>
          
        </td>
        
      </tr>
    </tbody>
  </table>

  <!-- üîπ Controles de Paginaci√≥n -->
  <div class="pagination-container">
    <button class="pagination-button" (click)="cambiarPagina(-1)" [disabled]="page === 1">
        Anterior
    </button>
    <span>P√°gina {{ page }} de {{ totalPaginas() }}</span>
    <button class="pagination-button" (click)="cambiarPagina(1)" [disabled]="page >= totalPaginas()">
        Siguiente
    </button>
</div>


  <!-- ‚úÖ MODAL DE CONFIRMACI√ìN -->
<div class="modal-overlay" *ngIf="confirmacionVisible">
  <div class="modal-content">
    <h3>Confirmaci√≥n</h3>
    <p>{{ mensajeConfirmacion }}</p>
    <div class="modal-buttons">
      <button (click)="confirmarAccion()" class="boton-confirmar">S√≠, confirmar</button>
      <button (click)="cancelarAccion()" class="boton-cancelar">Cancelar</button>
    </div>
  </div>
</div>

</div>


  
