<!-- pantalla-ver-tickets.component.html -->

<div class="contenedor-tickets">
  <div class="filtros">
    <label for="estado">Estado:</label>
    <select id="estado" [(ngModel)]="filtroEstado" (change)="filtrarTickets()">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="en progreso">En progreso</option>
      <option value="finalizado">Finalizado</option>
    </select>
  
    <label for="criticidad">Criticidad:</label>
    <select id="criticidad" [(ngModel)]="filtroCriticidad" (change)="filtrarTickets()">
      <option value="">Todas las criticidades</option>
      <option value="1">1 - Muy Baja</option>
      <option value="2">2 - Baja</option>
      <option value="3">3 - Media</option>
      <option value="4">4 - Alta</option>
      <option value="5">5 - Critico</option>
    </select>
  
    <label for="usuario">Usuario:</label>
    <input id="usuario" list="usuarios" [(ngModel)]="filtroUsuario" (input)="filtrarTickets()" placeholder="Buscar usuario...">
    <datalist id="usuarios">
      <option *ngFor="let user of usuariosDisponibles" [value]="user"></option>
    </datalist>
  
    <label for="fechaCreacion">Fecha de Creaci√≥n:</label>
    <input id="fechaCreacion" type="date" [(ngModel)]="filtroFecha" (change)="filtrarTickets()">
  
    <label for="fechaFinalizacion">Fecha de Finalizaci√≥n:</label>
    <input id="fechaFinalizacion" type="date" [(ngModel)]="filtroFechaFinalizacion" (change)="filtrarTickets()">
  </div>
  
  <button (click)="exportToExcel()">üì• Exportar a Excel</button>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>T√≠tulo</th>
        <th>Descripci√≥n</th>
        <th>Usuario</th>
        <th>Estado</th>
        <th>Criticidad</th>
        <th>Fecha Creaci√≥n</th>
        <th>Fecha Finalizado</th>
        <th>Acciones</th> <!-- ‚úÖ Agregamos la columna de botones -->
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let ticket of filteredTickets">
        <td>{{ ticket.id }}</td>
        <td>{{ ticket.titulo }}</td>
        <td>{{ ticket.descripcion }}</td>
        <td>{{ ticket.username }}</td>
        <td>{{ ticket.estado }}</td>
        <td>{{ ticket.criticidad }}</td>
        <td>{{ formatearFecha(ticket.fecha_creacion) }}</td>
        <td>{{ formatearFecha(ticket.fecha_finalizado ? ticket.fecha_finalizado : 'N/A') }}</td>
        <td>

        <ng-container *ngIf="user && user.id_sucursal === 1000 && ticket.estado !== 'finalizado'">

            <!-- ‚úÖ Bot√≥n "En Progreso" (solo si el usuario es admin y el ticket no est√° finalizado) -->
          <button 
          *ngIf="ticket.estado !== 'finalizado'" 
          [disabled]="ticket.estado === 'en progreso'" 
          (click)="cambiarEstadoTicket(ticket, 'en progreso')"
          [ngStyle]="{ 'background-color': ticket.estado === 'en progreso' ? 'gray' : 'green', 'color': 'white' }">
          En Progreso
          </button>

            <!-- ‚úÖ Bot√≥n "Finalizar" (solo si el usuario es admin y el ticket no est√° finalizado) -->
            <button 
            *ngIf="ticket.estado !== 'finalizado'"  
            (click)="finalizarTicket(ticket)"
            [ngStyle]="{ 'background-color': 'red', 'color': 'white', 'margin-left': '5px' }">
            Finalizar
          </button>
        </ng-container>
        </td>
      </tr>
    </tbody>
  </table>
</div>
  
